<div id="tooltip" class="tipsy tipsy-s">
<div class="tipsy-arrow tipsy-arrow-s"></div> <div class="tipsy-inner">
Your annotation will start here. Please click another word to set the end point.
<a href="#" id="cancel-annotation">cancel</a>
</div>
</div>

<a href="#" class="fixed_link left-tooltip" id="collapse_toggle" title="Toggle Right Panel">Collapse/Expand</a>
<a href="#" class="fixed_link requires_edit left-tooltip" id="edit_toggle" title="Toggle Edit Mode">Edit/View</a>
<a href="#" class="fixed_link left-tooltip" id="fixed_print" title="Print <%= @collage.name %>">Print</a>
<form action="<%= export_unique_collage_path(@collage) %>" target="_blank" method="POST" id="collage_print">
<input type="hidden" id="state" name="state" value="" />
</form>
<a href="#" class="fixed_link left-tooltip btn-a" id="fixed_font" title="Change the size of the text">Font Settings</a>

<div id="singleitem_barcode" class="right_panel">
<%= render :partial => "shared/barcode", :locals => { :object => @collage } %>
</div>

<aside id="singleitem_toolbar">
  <a href="#" id="heatmap_toggle" title="Show Heatmap" class="link-heatmap tooltip<%= ' inactive' if @collage.annotations.inject(0) { |s, a| s + a.annotation_word_count } == 0 %>"><span class="icon icon-heatmap"></a>
  <a href="<%= copy_collage_path(@collage) %>" class="tooltip link-copy requires_logged_in" id="copy-collage" title="Make a Copy of <%= @collage.name %>">
    <span class="icon icon-remix-large"></span>
  </a>
  <%= link_to raw('<span class="icon icon-add-large"></span>'), '#', "data-item_id" => @collage.id, "data-type" => "collage", :class => 'link-add tooltip requires_logged_in', :title => "Add to a Playlist" %>
  <%= link_to raw('<span class="icon icon-favorite-large"></span>'), '#', :class => "bookmark-action tooltip requires_logged_in", :title => "Bookmark #{@collage.name}", "data-type" => "collage", "data-itemid" => @collage.id %>
</aside>

<div id="collage" class="singleitem" data-itemid="<%= @collage.id %>">
  <div id="main_details">
    <h1><%= @collage.name %></h1>
    <h3>
      <span>by </span>
      <%= raw @collage.owners.collect { |u| link_to(u.display, user_path(u)) }.join(', ') %>
    </h3>
    <aside id="buttons">
      <ul>
        <li class="btn-li afterload">
          <a href="#" class="btn-a" id="text-tools">
            <span>TEXT</span>
          </a>
          <div class="popup text-popup">
            <ul>
              <li>
                <a href="#" class="tooltip" title="Show the entire text of <%= @collage.name %>" id="full_text">SHOW FULL TEXT</a>
              </li>
              <li>
                <a href="#" class="tooltip" title="Show <%= @collage.author %>'s version of the collage" id="author_edits">SHOW AUTHOR'S LAYERS</a>
              </li>
              <li>
                <a href="#" title="View all annotations" class="tooltip" id="show_annotations" <%= raw 'class="inactive"' if @collage.annotations.inject(0) { |s, a| s + a.annotation_word_count } == 0 %>>SHOW ANNOTATIONS</a>
                <a href="#" title="Hide all annotations" class="tooltip" id="hide_annotations" <%= raw 'class="inactive"' if @collage.annotations.inject(0) { |s, a| s + a.annotation_word_count } == 0 %>>HIDE ANNOTATIONS</a>
              </li>
            </ul>
          </div>
        </li>
        <li class="btn-li afterload">
          <a href="#" class="btn-a" id="layer-tools">
            <span>LAYERS</span>
          </a>
          <div class="popup layers-popup">
            <ul id="layers">
               <% @collage.layers.each do |layer| %>
              <li data-id="l<%= layer.id %>" data-name="<%= layer.name %>" data-hex="<%= @color_map["l#{layer.id}"] ? @color_map["l#{layer.id}"] : cycle('ffcc00', '99ccff', '99cc33', 'ff9999', 'b2c1d0', 'ff9933', 'cc99cc') %>">
                <strong><%= layer.name %></strong>
                <a href="#" class="hide_show shown tooltip" title="Hide the <%= layer.name %> layer" >HIDE</a>
                <a href="#" title="Highlight the <%= layer.name %> Layer" class="tooltip link-o">HIGHLIGHT</a>
                <div class="cl">&nbsp;</div>
              </li>
               <% end -%>
              <li id="unlayered_li">
                <a href="#" id="show_unlayered" class="tooltip"  title="Show All Unlayered">SHOW UNLAYERED</a>
                <a href="#" id="hide_unlayered" class="tooltip"  title="Hide All Unlayered">HIDE UNLAYERED</a>
              </li>
            </ul>
          </div>
        </li>
      </ul>
    </aside>
    <div class="clear"></div>
  </div>
  <div id="description">
    <%= Collage.format_content(@collage.description) %>
    <%= link_to raw('<span class="icon icon-edit"></span>EDIT COLLAGE INFORMATION<span class="icon icon-arrow"></span>'), edit_collage_path(@collage), :class => "edit-action requires_edit collage_edit smaller" %>
  </div>

  <div class="ajax-error" id="ajax-error-<%= @collage.id %>" style="display: none;"></div>
  <% cache("collage-#{@collage.id}-editable-content") do %>
  <article>
    <%= raw @collage.editable_content %>
  </article>
  <% end -%>
</div>

<div id="stats" class="right_panel">
  <a href="#" class="right_panel_close"></a>
  <h3 class="info">Collage Information<span class="icon icon-panel"></span></h3>
  <div class="stats_panel">
    <%= render :partial => 'meta' %>
  </div>
  <h3>Author Stats</h3>
  <%= render :partial => "shared/author_stats", :locals => { :user => @collage.owners.first } %>
  <% if false -%>
  <h3>Related Collages</h3>
  <% end -%>
</div>
<div id="edit_item" class="requires_edit right_panel">
  <a href="#" class="right_panel_close"></a>
  <table class="tabs" width="100%" cellpadding="0" cellspacing="0"><tr>
    <td width="50%"><a id="new_annotation" class="current" href="#">Annotate</a></td>
    <td><a id="new_link" href="#">Link</a></td>
  </tr></table>
  <div id="annotation_edit" class="tab_panel new_annotation">
    <p class="instruction">
      To create an annotation, click at the beginning and end of text that you would like
      to highlight, select layer, and enter annotation.
      <div class="dynamic"></div>
    </p>
  </div>
  <div id="link_edit" class="tab_panel new_link" style="display:none;">
    <p class="instruction">
      To create a link, MODIFIED INSTRUCTIONS.
      <div class="dynamic"></div>
    </p>
  </div>
</div>

<div class="cl"></div>
  
<%= render :partial => "shared/popup", :locals => { :type => "collage" } %>
 
<script type="text/javascript">
var editability_path = "<%= access_level_collage_path(@collage) %>"; 
var original_data = <%= raw @collage.readable_state || '{}' %>;
var annotations = <%= raw @collage.annotations.inject({}) { |h, a| h["a#{a.id}"] =  a.to_json(:include => :layers); h }.to_json %>;
var collage_links = <%= raw @collage.collage_links.inject({}) { |h, a| h["c#{a.id}"] =  a; h }.to_json %>;
var color_map = <%= raw Collage.color_map.to_json %>;
var layer_color_map = <%= raw @color_map.to_json %>;
</script>
